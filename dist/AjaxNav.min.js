/*!
bower-ajax-nav v0.0.0 
Ajax Navigation component
Build time: Tue May 28 2013 23:36:14 GMT+0100 (BST)
*/

(function(){var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__slice=[].slice;define("AjaxNav",["EventEmitter","mootools"],function(EventEmitter){var AjaxNav,ajaxNav;return AjaxNav=function(_super){function AjaxNav(){this.loadPage=__bind(this.loadPage,this),this.changeState=__bind(this.changeState,this),this.loadContent=__bind(this.loadContent,this),this.injectStylesheet=__bind(this.injectStylesheet,this),this.loadScripts=__bind(this.loadScripts,this),this.removePageStyles=__bind(this.removePageStyles,this),this.unloadRequireScripts=__bind(this.unloadRequireScripts,this),this.onSubmit=__bind(this.onSubmit,this),this.onClick=__bind(this.onClick,this),this.onEvent=__bind(this.onEvent,this),this.onPop=__bind(this.onPop,this),this.getXHR=__bind(this.getXHR,this);var _this=this;AjaxNav.__super__.constructor.call(this),"function"==typeof history.pushState&&(this.content=document.getElementById("main"),this.xhr=this.getXHR(),this.head=document.getElementsByTagName("head")[0],requirejs(["global"],function(global){var origin;return _this.defaultState={title:document.title,html:_this.content.innerHTML,url:window.location.href,stylesheets:global.stylesheets,scripts:global.scripts,requireScripts:global.requireScripts},_this.activeState=_this.defaultState,origin=window.location.origin,document.body.addEvent("click:relay(a[href^='/'], a[href^='"+origin+"'])",_this.onEvent),document.body.addEvent("submit:relay(form[action^='/'], form[action^='"+origin+"'])",_this.onEvent),window.addEventListener("popstate",_this.onPop)}))}return __extends(AjaxNav,_super),AjaxNav.prototype.getXHR=function(){var _this=this;return new Request.JSON({onRequest:function(){return _this.fireEvent("onRequest"),document.body.style.cursor="wait"},onSuccess:function(json){return _this.fireEvent("onXHRSuccess"),document.body.style.cursor="",null!=json.html?(_this.changeState(json),window.history.pushState(json,json.title,json.url)):void 0}})},AjaxNav.prototype.onPop=function(event){return this.fireEvent("onPopState"),this.changeState(event.state)},AjaxNav.prototype.onEvent=function(event){if(!(event.shift||event.alt||event.meta||event.event.defaultPrevented))switch(event.preventDefault(),event.type){case"click":return this.onClick(event);case"submit":return this.onSubmit(event)}},AjaxNav.prototype.onClick=function(event){var href;return href="A"===event.target.tagName?event.target.href:event.target.getParent("a").href,this.loadPage(href)},AjaxNav.prototype.onSubmit=function(event){var form;return form="FORM"===event.target.tagName?event.target:event.target.getParent("form"),this.xhr.isRunning()?void 0:this.xhr.send({url:form.action,data:form})},AjaxNav.prototype.unloadRequireScripts=function(cb){var onUnloadError,onUnloadSuccess;return onUnloadSuccess=function(){var module,modules,_i,_len,_results;for(modules=arguments.length>=1?__slice.call(arguments,0):[],_results=[],_i=0,_len=modules.length;_len>_i;_i++)module=modules[_i],null!=module&&"function"==typeof module.unload?_results.push(module.unload()):_results.push(void 0);return _results},onUnloadError=function(error){return console.error("AjaxNav: RequireJS unloadRequireScripts",error)},console.log("unload",this.activeState.requireScripts),requirejs(this.activeState.requireScripts,onUnloadSuccess,onUnloadError),"function"==typeof cb?cb():void 0},AjaxNav.prototype.removePageStyles=function(state){var href,_i,_len,_ref,_results;if(null!=state.stylesheets){for(_ref=state.stylesheets,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)href=_ref[_i],console.log("removing stylesheet","link[href*='"+href+"']"),_results.push($$("link[href*='"+href+"']").destroy());return _results}},AjaxNav.prototype.loadScripts=function(state,cb){var loadScriptsError,loadScriptsSuccess;return null!=state.scripts&&state.scripts.length>0?(loadScriptsSuccess=cb,loadScriptsError=function(error){return console.warn("AjaxNav loadScripts: RequireJS failed to load scripts due to "+error.requireType,error.requireModules),loadScriptsSuccess()},requirejs(state.scripts,loadScriptsSuccess,loadScriptsError)):cb()},AjaxNav.prototype.injectStylesheet=function(href){var stylesheet;return stylesheet=document.createElement("link"),stylesheet.setAttribute("rel","stylesheet"),stylesheet.setAttribute("type","text/css"),stylesheet.setAttribute("href",href),this.head.appendChild(stylesheet)},AjaxNav.prototype.loadContent=function(state){var href,_i,_len,_ref;if(null!=state.stylesheets)for(_ref=state.stylesheets,_i=0,_len=_ref.length;_len>_i;_i++)href=_ref[_i],this.injectStylesheet(href);return this.content.set("html",state.html),this.activeState=state,requirejs(state.requireScripts,function(){var module,modules,_j,_len1,_results;for(modules=arguments.length>=1?__slice.call(arguments,0):[],_results=[],_j=0,_len1=modules.length;_len1>_j;_j++)module=modules[_j],null!=module&&"function"==typeof module.load?_results.push(module.load()):_results.push(void 0);return _results}),this.fireEvent("onContentLoaded")},AjaxNav.prototype.changeState=function(state){var _this=this;return null==state&&(state=this.defaultState),window.scrollTo(0,0),document.title=state.title,"undefined"!=typeof _gaq&&null!==_gaq&&_gaq.push(["_trackPageview",state.url]),this.unloadRequireScripts(function(){return _this.loadScripts(state,function(){return _this.removePageStyles(_this.activeState),_this.loadContent(state)})})},AjaxNav.prototype.loadPage=function(url){return url===window.location.href&&window.location.reload(),this.xhr.isRunning()&&this.xhr.cancel(),this.xhr.send({url:url,method:"get"})},AjaxNav}(EventEmitter),ajaxNav=new AjaxNav})}).call(this);